<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>pickyourtrail Live Chat</title>

  <script src="https://wchat.freshchat.com/js/widget.js"></script>
  <style>
    .chat-close-placeholder {
      height: 25px;
      width: 25px;
      border-radius: 100%;
      background-color: #00C684;
      position: absolute;
      top: 6px;
      right: 16px;
      z-index: 1000000000000000000000;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
<img src="/pyt-white.png" class="chat-close-placeholder hidden"/>
<script>
  var getUrlParams = function(url) {
    var result = {};
    var params = (url.split("?")[1] || "").split("&");
    for (var param in params) {
      if (params.hasOwnProperty(param)) {
        var paramParts = params[param].split("=");
        result[paramParts[0]] = decodeURIComponent(paramParts[1] || "");
      }
    }
    return result;
  };

  var queryParams = getUrlParams(window.location.href);

  /**
   * If a previous session of fcWidget is initialized, destroy it
   */
  if (window.fcWidget.isInitialized() === true) {
    window.fcWidget.destroy();
  }

  /**
   * Initialize the widget with the required IDs & tags
   */
  window.fcWidget.init({
    token: queryParams.token,
    host: queryParams.host,
    externalId: queryParams.feid,
    restoreId: queryParams.frid ? queryParams.frid : null,
    tags: queryParams.region ? decodeURI(queryParams.region).split(',') : []
  });

  /**
   * Open up the widget in the UI
   */
  window.fcWidget.open();

  /**
   * If a restore id is not present, the user is new and must be created.
   */
  if (!queryParams.frid) {
    window.fcWidget.on("user:statechange", function(userStateDetails) {
      var userState = userStateDetails.data.userState;
      console.log('Initial UserState', userState);
      if (userState === "not_loaded" || userState === "not_created" || userState === "identified") {
        window.fcWidget.user.create({
          externalId: queryParams.feid,
          firstName: queryParams.trailId,
          lastName: queryParams.name,
          email: queryParams.email,
          phone: queryParams.mob_num,
          phoneCountryCode: queryParams.ccode,
        });
      } else if(userState === "created") {
        window.fcWidget.user.get(function(userDetails) {
          if (userDetails.status === 200 && userDetails.success && userDetails.data) {
            var actorId = userDetails.data.alias;
            var restoreId = userDetails.data.restoreId;
            console.log('Actor details', {
              userState: userStateDetails,
              userDetails: userDetails
            });
            window.ReactNativeWebView && window.ReactNativeWebView.postMessage(JSON.stringify({
              restoreId: restoreId,
              actorId: actorId
            }));
          } else {
            console.log("Failed to get actor id", {
              userState: userStateDetails,
              userDetails: userDetails
            });
            window.ReactNativeWebView && window.ReactNativeWebView.postMessage(JSON.stringify({
              error: "Failed to get actor id",
              userState: userStateDetails,
              actorIdResponse: userDetails
            }));
          }
        });
      }
    });
  }

  window.fcWidget.on("widget:opened", function(resp) {
    var $placeHolder = document.querySelector('.chat-close-placeholder');
    $placeHolder.classList.remove('hidden');
  });

  window.fcWidget.on("widget:closed", function(resp) {
    window.fcWidget.open();
  });
</script>
</body>

</html>
